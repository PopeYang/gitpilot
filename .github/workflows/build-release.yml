name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  QT_VERSION: '6.8.3'
  QT_ARCH: 'win64_msvc2022_64'
  BUILD_TYPE: 'Release'

jobs:
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      
      # 2. è®¾ç½® MSVC çŽ¯å¢ƒ
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2
      
      - name: Setup MSVC Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      # 3. å®‰è£… Qt
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: ${{ env.QT_ARCH }}
          cache: true  # å¯ç”¨ç¼“å­˜åŠ é€Ÿ
          modules: ''  # ä¸éœ€è¦é¢å¤–æ¨¡å—
      
      # 4. é…ç½® CMake
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -G "Visual Studio 17 2022" `
            -A x64
      
      # 5. ç¼–è¯‘é¡¹ç›®
      - name: Build Project
        run: |
          cd build
          cmake --build . --config ${{ env.BUILD_TYPE }} --parallel
      
      # 6. å‡†å¤‡éƒ¨ç½²ç›®å½•
      - name: Prepare Deploy Directory
        run: |
          New-Item -ItemType Directory -Path deploy -Force
          Copy-Item "build\${{ env.BUILD_TYPE }}\gitpilot.exe" deploy\
      
      # 7. ä½¿ç”¨ windeployqt æ”¶é›†ä¾èµ–
      - name: Deploy Qt Dependencies
        run: |
          windeployqt --release --no-compiler-runtime --no-translations deploy\gitpilot.exe
      
      # 8. å¤åˆ¶æ–‡æ¡£
      - name: Copy Documentation
        run: |
          Copy-Item README.md deploy\
          Copy-Item ä½¿ç”¨æŒ‡å—.md deploy\
          Copy-Item æ‰“åŒ…åˆ†å‘æŒ‡å—.md deploy\ -ErrorAction SilentlyContinue
      
      # 9. åˆ›å»ºç»¿è‰²ç‰ˆ ZIP
      - name: Create Portable ZIP
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          if ([string]::IsNullOrEmpty($version)) {
            $version = "dev-$(Get-Date -Format 'yyyyMMdd')"
          }
          Compress-Archive -Path deploy\* -DestinationPath "GitPilot-$version-Portable.zip"
      
      # 10. ä¸‹è½½ Inno Setupï¼ˆç”¨äºŽåˆ¶ä½œå®‰è£…åŒ…ï¼‰
      - name: Download Inno Setup
        run: |
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "innosetup.exe"
          Start-Process -FilePath "innosetup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
      
      # 11. æ›´æ–°å®‰è£…è„šæœ¬ç‰ˆæœ¬å·
      - name: Update Installer Version
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          if ([string]::IsNullOrEmpty($version)) {
            $version = "0.0.0-dev"
          }
          (Get-Content installer.iss) -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`"" | Set-Content installer.iss
      
      # 12. ç¼–è¯‘å®‰è£…åŒ…
      - name: Build Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
      
      # 13. èŽ·å–å®‰è£…åŒ…æ–‡ä»¶å
      - name: Get Installer Filename
        id: installer
        run: |
          $installer = Get-ChildItem installer_output\*.exe | Select-Object -First 1
          echo "filename=$($installer.Name)" >> $env:GITHUB_OUTPUT
          echo "path=$($installer.FullName)" >> $env:GITHUB_OUTPUT
      
      # 14. ä¸Šä¼ æž„å»ºäº§ç‰©ï¼ˆArtifactï¼‰
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GitPilot-Windows-${{ github.ref_name }}
          path: |
            GitPilot-*.zip
            installer_output/*.exe
          retention-days: 30
      
      # 15. åˆ›å»º GitHub Releaseï¼ˆä»…æ ‡ç­¾è§¦å‘æ—¶ï¼‰
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            GitPilot-*.zip
            installer_output/*.exe
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## GitPilot ${{ github.ref_name }}
            
            ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
            
            - **å®‰è£…åŒ…ç‰ˆæœ¬**: `${{ steps.installer.outputs.filename }}`  
              æŽ¨èå¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ï¼ŒåŒå‡»å®‰è£…å³å¯
            
            - **ç»¿è‰²ç‰ˆ**: `GitPilot-*-Portable.zip`  
              è§£åŽ‹å³ç”¨ï¼Œæ— éœ€å®‰è£…
            
            ### ðŸ”§ ç³»ç»Ÿè¦æ±‚
            
            - Windows 10/11 x64
            - å¦‚æç¤ºç¼ºå°‘ DLLï¼Œè¯·å®‰è£… [VC++ å¯å†å‘è¡Œç»„ä»¶](https://aka.ms/vs/17/release/vc_redist.x64.exe)
            
            ### ðŸ“ å˜æ›´æ—¥å¿—
            
            è¯¦è§ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°å†…å®¹
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 16. æž„å»ºæ‘˜è¦
      - name: Build Summary
        if: always()
        run: |
          echo "### ðŸŽ‰ GitPilot æž„å»ºå®Œæˆ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | ä¿¡æ¯ |" >> $env:GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ github.ref_name }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Qt ç‰ˆæœ¬ | ${{ env.QT_VERSION }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç±»åž‹ | ${{ env.BUILD_TYPE }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          
          $zipFile = Get-ChildItem GitPilot-*.zip | Select-Object -First 1
          if ($zipFile) {
            $zipSize = [math]::Round($zipFile.Length / 1MB, 2)
            echo "| ç»¿è‰²ç‰ˆ | $($zipFile.Name) ($zipSize MB) |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          $exeFile = Get-ChildItem installer_output\*.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exeFile) {
            $exeSize = [math]::Round($exeFile.Length / 1MB, 2)
            echo "| å®‰è£…åŒ… | $($exeFile.Name) ($exeSize MB) |" >> $env:GITHUB_STEP_SUMMARY
          }
